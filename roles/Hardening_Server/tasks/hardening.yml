---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600


- name: Install baseline packages
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present 
  loop:
    - openssh-server
    - auditd
    - libpam-modules
    - libpam-passwdqc

- name: Remove deprecated & insecure legacy packages
  ansible.builtin.apt:
    name: "{{ legacy_packages_remove }}"
    state: absent
    purge: true
 

- name: Write hardened sysctl config
  ansible.builtin.template:
    src: sysctl-hardening.j2
    dest: /etc/sysctl.d/hardening.conf
    owner: root
    group: root
    mode: "0644"
  notify: reload sysctl


- name: Secure cron directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0700"
  loop:
    - /etc/cron.hourly
    - /etc/cron.daily
    - /etc/cron.weekly
    - /etc/cron.monthly


- name: Secure /etc/crontab
  ansible.builtin.file:
    path: /etc/crontab
    state: file
    owner: root
    group: root
    mode: "0600"


- name: Remove cron.deny and at.deny
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cron.deny
    - /etc/at.deny


- name: Allow-only root for cron/at
  ansible.builtin.copy:
    dest: "{{ item }}"
    content: "root\n"
    owner: root
    group: root
    mode: "0600"
  loop:
    - /etc/cron.allow
    - /etc/at.allow


- name: Ensure permissions for passwd, group, shadow, gshadow
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "{{ item.mode }}"
  loop:
    - { path: '/etc/passwd',  mode: '0644' }
    - { path: '/etc/group',   mode: '0644' }
    - { path: '/etc/shadow',  mode: '0640' }
    - { path: '/etc/gshadow', mode: '0640' }


- name: Ensure auditd installed
  ansible.builtin.apt:
    name: auditd
    state: present

- name: Baseline /etc/audit/auditd.conf 
  ansible.builtin.template:
    src: auditd.conf.j2
    dest: /etc/audit/auditd.conf
    mode: "0640"
    owner: root
    group: root
  notify: restart auditd

- name: Configure passwdqc 
  ansible.builtin.template:
    src: pam_passwdqc.j2
    dest: /usr/share/pam-configs/pam_passwdqc
    owner: root
    group: root
    mode: "0644"

- name: Configure /etc/security/faillock.conf
  ansible.builtin.copy:
    dest: /etc/security/faillock.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      deny = {{ faillock.deny }}
      unlock_time = {{ faillock.unlock_time }}
      {% if faillock.even_deny_root %}even_deny_root{% endif %}
      {% if faillock.audit %}audit{% endif %}

- name: Enforce umask 027 globally (/etc/profile.d)
  ansible.builtin.copy:
    dest: /etc/profile.d/umask.sh
    mode: "0644"
    owner: root
    group: root
    content: |
      umask 027

- name: Harden /etc/login.defs 
  ansible.builtin.blockinfile:
    path: /etc/login.defs
    create: true
    block: |
      PASS_MAX_DAYS   {{ login_defs.PASS_MAX_DAYS }}
      PASS_MIN_DAYS   {{ login_defs.PASS_MIN_DAYS }}
      PASS_WARN_AGE   {{ login_defs.PASS_WARN_AGE }}
      LOGIN_RETRIES   {{ login_defs.LOGIN_RETRIES }}
      UMASK           {{ login_defs.UMASK }}
      FAILLOG_ENAB    {{ login_defs.FAILLOG_ENAB }}
      LOG_OK_LOGINS   {{ login_defs.LOG_OK_LOGINS }}
      LOG_UNKFAIL_ENAB {{ login_defs.LOG_UNKFAIL_ENAB }}

- name: Disable core dumps via limits
  ansible.builtin.copy:
    dest: /etc/security/limits.d/hardening.conf
    mode: "0644"
    owner: root
    group: root
    content: |
      * hard core 0
      * soft core 0

- name: Blacklist uncommon filesystems
  ansible.builtin.template:
    src: filesystems.conf.j2
    dest: /etc/modprobe.d/filesystems.conf
    mode: "0644"
    owner: root
    group: root



- name: Insert pam_faillock preauth before pam_unix.so
  community.general.pamd:
    name: common-auth

    type: auth
    control: "[success=1 default=ignore]"
    module_path: pam_unix.so

    new_type: auth
    new_control: required
    new_module_path: pam_faillock.so
    module_arguments: "preauth silent audit deny=5 unlock_time=900"
    state: before


- name: Insert pam_faillock authfail after pam_unix.so
  community.general.pamd:
    name: common-auth

    type: auth
    control: "[success=1 default=ignore]"
    module_path: pam_unix.so

    new_type: auth
    new_control: "[default=die]"
    new_module_path: pam_faillock.so
    module_arguments: "authfail audit deny=5 unlock_time=900"
    state: after


- name: Ensure pam_faillock in common-account
  community.general.pamd:
    name: common-account

    type: account
    control: required
    module_path: pam_unix.so

    new_type: account
    new_control: required
    new_module_path: pam_faillock.so
    state: after


- name: Enable passwdqc policy in common-password
  community.general.pamd:
    name: common-password

    type: password
    control: "[success=1 default=ignore]"
    module_path: pam_unix.so

    new_type: password
    new_control: requisite
    new_module_path: pam_passwdqc.so
    module_arguments: "min=disabled,24,11,8,7 max=40 retry=3"
    state: before
